---
title: "Comparison of interventions for chronic pain in adults"
subtitle: "NNT edition"
author: "Thursday 2 December 2021"
output: 
  #html_document
  # io_slides_document
  # ioslides_presentation:
  #   fig_width: 10
  #   fig_height: 6
  #   widescreen: true
  # pdf_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE)
```

```{r}
library(metafor)
library(adpain)
library(kableExtra)
library(patchwork)
library(adpain)
library(targets)

withr::with_dir(here::here(), {
  tar_load(nnt_results)
  tar_load(oti_pw)
  tar_load(oti_results)
  tar_load(oti_sof)
  tar_load(o_nma_key)
  tar_load(intervention_key)
  tar_load(nnt_wide)
  tar_load(type_key)
  tar_load(nnt_con_wide)
  tar_load(nnt_con_results)
  
  source("R/rep_output.R")
})

```

```{r}
nnt_tab <- function(dat) {
  dat %>% 
  cols_label(
    pain_sub_nnt = "NNTB",
    pain_sub_participants = "n",
    pain_sub_studies = "RCT",
    pain_mod_nnt = "NNTB",
    pain_mod_participants = "n",
    pain_mod_studies = "RCT",
    pgic_any_improvement_nnt = "NNTB",
    pgic_any_improvement_participants = "n",
    pgic_any_improvement_studies = "RCT",
    pgic_much_or_very_much_improved_nnt = "NNTB",
    pgic_much_or_very_much_improved_participants = "n",
    pgic_much_or_very_much_improved_studies = "RCT",
    adverse_dropout_nnt = "NNTH",
    adverse_dropout_participants = "n",
    adverse_dropout_studies = "RCT",
        withdrawal_nnt = "NNTH",
    withdrawal_participants = "n",
    withdrawal_studies = "RCT",
        adverse_nnt = "NNTH",
    adverse_participants = "n",
    adverse_studies = "RCT",
        serious_adverse_nnt = "NNTH",
    serious_adverse_participants = "n",
    serious_adverse_studies = "RCT"
  ) %>% 
  tab_spanner(
    label = "50% reduction",
    columns = contains("pain_sub")
  ) %>% 
  tab_spanner(
    label = "30% reduction",
    columns = contains("pain_mod")
  ) %>% 
  tab_spanner(
    label = "dropout",
    columns = contains("dropout")
  ) %>% 
  tab_spanner(
    label = "withdrawal",
    columns = contains("withdrawal")
  ) %>% 
  tab_spanner(
    label = "adverse",
    columns = c(adverse_nnt, adverse_participants, adverse_studies)
  ) %>% 
  tab_spanner(
    label = "serious",
    columns = contains('serious')
  ) %>% 
  tab_spanner(
    label = "PGIC (any)",
    columns = contains('pgic_any')
  ) %>% 
  tab_spanner(
    label = "PGIC (much)",
    columns = contains('pgic_much')
  ) %>% 
  tab_style(
        style = cell_borders(sides = "right", color = "grey",
                             style = "dotted", weight = px(3)),
        locations = cells_body(columns = 
                                 c(pain_sub_studies,
                                   adverse_dropout_studies,
                                   withdrawal_studies,
                                   adverse_studies,
                                   pgic_any_improvement_studies
                                   
                                   )
                                 
                                 )) %>% 
  tab_style(
        style = cell_borders(sides = "right", color = "grey", weight = px(3)),
        locations = cells_body(
          columns = c(pain_mod_studies))) %>% 
  tab_options(
    table.font.size = 11.5
  ) %>% 
    data_color(
    columns = c(pain_sub_nnt, pain_mod_nnt,
                pgic_any_improvement_nnt, pgic_much_or_very_much_improved_nnt),
    colors = scales::col_numeric(
      palette = c(
        "white",
        # "#bf8026",
        # "#62799e", 
        "#789e62") %>% rev(),
      domain = NULL),
    alpha = 0.5
  ) %>% 
        data_color(
    columns = c(adverse_dropout_nnt, withdrawal_nnt,
                adverse_nnt, serious_adverse_nnt),
    colors = scales::col_numeric(
      palette = c(
        "white",
        # "#bf8026",
        # "#91422c",
        # "#62799e",
        "#b0350c"
        ) %>% rev(),
      domain = NULL),
    alpha = 0.5,
    autocolor_text = FALSE
  ) %>% 
    tab_style(
      style = list(cell_text(weight = "bold", color = "black")),
      locations = cells_body(
        columns = contains("nnt")
      )
    ) 

}

```

# Story so far

## Story so far

- Only have data at follow-up for two outcomes; all analyses post-intervention or change-score from baseline
- All NNT results post-intervention
- Most evidence focuses on SNRI and TCA: duloxetine, amitriptyline, milnacipran, and esreboxetine 
- Direct evidence by condition, dose, and class is largely consistent with NMA findings
- Little difference between standard-high doses and conditions
- Overall, duloxetine > other antidepressants in both NNTB & NNTH


```{r}
tibble(
  a = c("NNTB", "NNTH"),
  b = c("Number needed to treat to benefit", "Number needed to treat to harm")
) %>% 
  pivot_wider(
    names_from = a,
    values_from = b
  ) %>% 
  gt()


```

# Overall summary by NNT

```{r}
big_enough <- 
nnt_results %>% 
  select(outcome, timepoint, intervention, participants) %>% 
  group_by(intervention, timepoint) %>% 
  summarise(
    n_big = sum(participants > 200)
  ) %>% 
  filter(n_big != 0)

```

```{r}
tab_dat <- 
nnt_wide %>% 
  inner_join(big_enough %>% select(-n_big)) %>% 
  mutate(
    intervention = fct_relevel(intervention, 
                               "duloxetine",
                               "amitriptyline",
                               "milnacipran"),
    class = fct_relevel(class,
                        "SNRI",
                        "TCA",
                        "SSRI")
  ) %>% 
  left_join(type_key) %>% 
  arrange(intervention, class, timepoint) %>%   
  mutate(across(-c(class, intervention), ~ifelse(
    is.infinite(.x),
    NA,
    .x
  ))) %>%
  # mutate(across(-c(class, intervention), ~ifelse(
  #   is.infinite(.x),
  #   "",
  #   .x
  # ))) %>% 
  # mutate(across(everything(), replace_na, "")) %>% 
  mutate(class = replace_na(as.character(class), "")) %>% 
    mutate(
    intervention = as.character(intervention),
    class = as.character(class)
  ) %>% 
  select(-timepoint)

```


## SNRI & TCA

```{r}



tab_dat %>% 
  filter(type == "ad",
         class %in% c("SNRI", "TCA")) %>% 
  select(-contains("type")) %>% 
    gt(
    groupname_col = "class",
    rowname_col = "intervention",
    auto_align = FALSE
  ) %>% 
  nnt_tab()


```

## Other antidepressants

```{r}

tab_dat %>% 
  arrange(intervention, class) %>% 
  filter(type == "ad",
         class != "SNRI", class != "TCA") %>% 
  select(-contains("type")) %>% 
    gt(
    groupname_col = "class",
    rowname_col = "intervention",
    auto_align = FALSE
  ) %>% 
 nnt_tab()



```


## Other interventions

```{r}

tab_dat %>% 
  filter(type != "ad") %>% 
  mutate(
    intervention = as.character(intervention),
    class = as.character(class)
  ) %>% 
  select(-class, -type) %>% 
    gt(
    groupname_col = "type_label",
    rowname_col = "intervention",
    auto_align = FALSE
  ) %>% 
 nnt_tab()
  

```


## NNT by condition


```{r}
big_enough <- 
nnt_con_results %>% 
  select(outcome, timepoint, intervention, condition, participants) %>% 
  group_by(intervention, timepoint, condition) %>% 
  summarise(
    n_big = sum(participants > 200)
  ) %>% 
  filter(n_big != 0) %>% 
  ungroup()

```


```{r}
nnt_con_wide %>%
    mutate(across(-c(class, intervention), ~ifelse(
    is.infinite(.x),
    NA,
    .x
  ))) %>%
  inner_join(big_enough %>% select(-n_big)) %>% 
  # filter(type != "ad") %>% 
  mutate(
    intervention = as.character(intervention),
    class = as.character(class)
  ) %>% 
  # only post-int
  select(-class, -type, -timepoint) %>% 
  distinct() %>% 
    gt(
    groupname_col = "condition",
    rowname_col = "intervention",
    auto_align = FALSE
  ) %>% 
   cols_label(
    pain_sub_nnt = "NNTB",
    pain_sub_participants = "n",
    pain_sub_studies = "RCT",
    pain_mod_nnt = "NNTB",
    pain_mod_participants = "n",
    pain_mod_studies = "RCT",
    # pgic_any_improvement_nnt = "NNTB",
    # pgic_any_improvement_participants = "n",
    # pgic_any_improvement_studies = "RCT",
    pgic_much_or_very_much_improved_nnt = "NNTB",
    pgic_much_or_very_much_improved_participants = "n",
    pgic_much_or_very_much_improved_studies = "RCT",
    adverse_dropout_nnt = "NNTH",
    adverse_dropout_participants = "n",
    adverse_dropout_studies = "RCT",
        withdrawal_nnt = "NNTH",
    withdrawal_participants = "n",
    withdrawal_studies = "RCT",
        adverse_nnt = "NNTH",
    adverse_participants = "n",
    adverse_studies = "RCT",
        serious_adverse_nnt = "NNTH",
    serious_adverse_participants = "n",
    serious_adverse_studies = "RCT"
  ) %>% 
  tab_spanner(
    label = "50% reduction",
    columns = contains("pain_sub")
  ) %>% 
  tab_spanner(
    label = "30% reduction",
    columns = contains("pain_mod")
  ) %>% 
  tab_spanner(
    label = "dropout",
    columns = contains("dropout")
  ) %>% 
  tab_spanner(
    label = "withdrawal",
    columns = contains("withdrawal")
  ) %>% 
  tab_spanner(
    label = "adverse",
    columns = c(adverse_nnt, adverse_participants, adverse_studies)
  ) %>% 
  tab_spanner(
    label = "serious",
    columns = contains('serious')
  ) %>% 
  tab_spanner(
    label = "PGIC (any)",
    columns = contains('pgic_any')
  ) %>% 
  tab_spanner(
    label = "PGIC (much)",
    columns = contains('pgic_much')
  ) %>% 
  tab_style(
        style = cell_borders(sides = "right", color = "grey",
                             style = "dotted", weight = px(3)),
        locations = cells_body(columns = 
                                 c(pain_sub_studies,
                                   adverse_dropout_studies,
                                   withdrawal_studies,
                                   adverse_studies
                                   
                                   )
                                 
                                 )) %>% 
  tab_style(
        style = cell_borders(sides = "right", color = "grey", weight = px(3)),
        locations = cells_body(
          columns = c(pain_mod_studies))) %>% 
  tab_options(
    table.font.size = 11.5
  ) %>% 
    data_color(
    columns = c(pain_sub_nnt, pain_mod_nnt,pgic_much_or_very_much_improved_nnt),
    colors = scales::col_numeric(
      palette = c(
        "white",
        # "#bf8026",
        # "#62799e", 
        "#789e62") %>% rev(),
      domain = NULL),
    alpha = 0.5
  ) %>% 
        data_color(
    columns = c(adverse_dropout_nnt, withdrawal_nnt,
                adverse_nnt, serious_adverse_nnt),
    colors = scales::col_numeric(
      palette = c(
        "white",
        # "#bf8026",
        # "#91422c",
        # "#62799e",
        "#b0350c"
        ) %>% rev(),
      domain = NULL),
    alpha = 0.5,
    autocolor_text = FALSE
  ) %>% 
    tab_style(
      style = list(cell_text(weight = "bold", color = "black")),
      locations = cells_body(
        columns = contains("nnt")
      ))
 
```

## NNT by timepoint


## NNT by risk of bias



# Pain

```{r}
# set outcome
this_outcome <- "pain_int"
this_tp <- "change_score"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```

# `r outcome_label("pain_int") %>% str_to_sentence()`

## Summary of findings: CS

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


```{r}
# set outcome
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: PI

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```

# `r outcome_label("pain_sub") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "pain_sub"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


# `r outcome_label("pain_mod") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "pain_mod"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)
```



# `r outcome_label("mood") %>% str_to_sentence()`


```{r}
# set outcome
this_outcome <- "mood"
this_tp <- "change_score"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: CS

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


```{r}
# set outcome
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: PI

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


# `r outcome_label("sleep") %>% str_to_sentence()`


```{r}
# set outcome
this_outcome <- "sleep"
this_tp <- "change_score"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: CS

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


```{r}
# set outcome
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: PI

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


# `r outcome_label("physical") %>% str_to_sentence()`


```{r}
# set outcome
this_outcome <- "physical"
this_tp <- "change_score"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: CS

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


```{r}
# set outcome
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: PI

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```



# `r outcome_label("qol") %>% str_to_sentence()`


```{r}
# set outcome
this_outcome <- "qol"
this_tp <- "change_score"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: CS

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```


```{r}
# set outcome
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings: PI

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```



# `r outcome_label("pgic_cont") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "pgic_cont"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```



# `r outcome_label("pgic_any_improvement") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "pgic_any_improvement"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```



# `r outcome_label("pgic_much_or_very_much_improved") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "pgic_much_or_very_much_improved"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```



# `r outcome_label("withdrawal") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "withdrawal"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```




# `r outcome_label("adverse") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "adverse"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```




# `r outcome_label("serious_adverse") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "serious_adverse"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```




# `r outcome_label("adverse_dropout") %>% str_to_sentence()`

```{r}
# set outcome
this_outcome <- "adverse_dropout"
this_tp <- "post_int"

```

```{r}
# set mod
this_mod <- get_o_nma(this_outcome, this_tp, o_nma_key)

```


## Summary of findings

<div class="columns-2">

```{r }
pres_pico(this_mod)

```

<br>

```{r out.width="90%"}
suppressWarnings(this_mod$network %>% plot())


```

</div>

***

```{r}
rep_sof(this_outcome, this_tp)

```



