# Documentation

## ACR

Let $k$ denote an outcome and $i$ an observation for that outcome, then the assumed comparator risk (ACR) is calculated:

$$
\Sigma_{ki} r_{ki} / \Sigma_{ki} n_{ki}
$$

## Calculations for missing observations

Where possible required statistics calculated from reported statistics.

Confidence intervals assumed to have $\alpha = 0.05$; i.e., 95% confidence intervals assumed.  

If medians and interquartile ranges were reported, then means and standard deviations were estimated using an implmentation [@gray_2021] of [@wan_2014]'s method.

Symbol | Statistic
-|-
$n$ | Sample size
$r$ | Rate
$s$ | Standard deviation
$\text{se}$ | Standard error
$U$ | Upper confidence interval
$L$ | Lower confidence interval
$\alpha$ | Confidence level (0.05 assumed)
$\overline x$ | Mean
$\Phi$ | Standard normal cumulative density function
$M$ | Median

Missing | Reported | Calculation | Code
-|-|-----------|---------------------------
$n$ | $\%, r$ | $n = r / \%$ | `n = round(r / r_percent)`
$r$ | $\%, n$ | $r = \% \times n$ | `\r = r_percent * n` 
$s$, $\text{se}$ | $\overline x, n, U$ | $s = \sqrt{n}(U - \overline x)/\Phi^{-1}(1 - \alpha/2)$ | `sd = sqrt(n) * (ci_upper - mean) / qnorm(1 - 0.05/2)`
$s$, $\text{se}$ | $\overline x, n, L$ | $s = \sqrt{n}(\overline x - L)/\Phi^{-1}(1 - \alpha/2)$ | `sd = sqrt(n) * (mean - ci_lower) / qnorm(1 - 0.05/2)`
$\overline x$ | $M, U, L$ | $\overline x \approx (L + M + U)/3$ [@wan_2014] | `mean = varameta::wan_mean_C3(q_1 = iqr_lower, m = median, q_3 = iqr_higher)` [@gray_2021]
$\text{se}$ | $M, U, L, n$ | $\text{se} = (U - L)/(2\sqrt{n}\Phi^{-1}((0.75n-0.125)/(n+0.25)))$ [@wan_2014] | `se = varameta::wan_se_C3(q_1 = iqr_lower, m = median, q_3 = iqr_higher, n = n)` [@gray_2021]
$s$ | $\text{se}, n$ | $s = \text{se} \times \sqrt{n}$ | `sd = se * sqrt(n)`
$\text{se}$ | $s, n$ | $\text{se} = s / \sqrt{n}$ | `se = sd / sqrt(n)`

## Direction of improvement

The assumed direction of improvement for each outcome is encoded in `direction_of_improvement` (see table below). For standardised mean difference `smd` outcomes, where the scale reported was opposite to the assumed direction, the mean was set to `-mean`.

```{r dir, fig.cap="Assumed direction of improvement for each outcome."}
obs_dat %>% 
  filter(!str_detect(outcome, "_adverse|adverse_"), 
         !is.na(outcome)) %>% 
  count(outcome, direction_of_improvement, scale_dir, model_type)  %>% 
  gt()


```

## Are the converted values similar to the raw values? 

In the below table, ... for the same scale and outcome?

```{r pw-nma, fig.cap="For the same outcome, and scale, do the converted values broadly agree with the raw values?"}


```



## Number of studies extracted: `r w_obs_outcome %>% pull(study_id) %>% unique() %>% length()`

## Excluded observations: `r nrow(obs_excluded)` from `r obs_excluded %>% pull(study_id) %>% unique() %>% length()` studies

For odds-ratio the rate and sample size are required for NMA, and for standardised mean difference, the mean, standard deviation, and sample size are required. Where there are missing reported statistics, and required statistics cannot be calculated from what is reported, the observations are excluded from the models. 


```{r}
obs_excluded %>% 
  count(study_id, timepoint, change_score) %>% 
  gt() %>% 
  tab_header("Number of observations (study/arm statistics) excluded by study")
```


```{r}
obs_excluded %>% 
  select(exclusion_reason, gs_row, outcome, study_id, intervention, timepoint, mean:change_score) %>% 
  gt(groupname_col = "study_id",
     rowname_col = "exclusion_reason"
     ) %>% 
  tab_header("Observations currently excluded") %>% 
  tab_options(
    table.font.size = 12,
        row_group.background.color = hpp_pal(1)

  )

```


## Random sample checked

```{r}

checked_obs <- list(
  checked = sum(!is.na(w_obs_outcome$date_checked)),
  total_obs = nrow(w_obs_outcome)
)

checked_obs$prop <- checked_obs$checked/checked_obs$total_obs

checked_obs %>% 
  as_tibble() %>% 
  gt() %>% 
  cols_label(
    checked = "Observations checked (statistics reported for one arm of one study)",
    total_obs = "Total observations extracted",
    prop = "Proportion of observations checked"
  ) %>% 
  tab_header(
    title = "Charles' progress checking Covidence records against dataset"
  )

```


# Pipeline

We need pairwise and NMA available on the data with specifications for

- outcomes
- timepoints
- class
- dose
- type of comparison made

We need to verify the data are what we think they are, what model is output, 
and capture meta-data about the analysis. Crucially, plot output needs to be captured in the output meta-data, as does the location of the model. 

The clean data is found in `mod_dat`.

```{r echo=TRUE, eval=TRUE}
tar_load(mod_dat)

mod_dat %>% 
  dim()

mod_dat %>% sample_n(10) %>% head()

```

## Getting data

Based on specific filters, we want to get data for NMA or for PW.

-[] Create get NMA dat fn.
-[] Create get MA dat fn.
- Resist the urge to combine the two.
-[] Create target to test get NMA.
-[] Create in document.
-[] Write example.
-[] Write asserts or tests based on example.

For example, suppose we wish to 

Let's check that our function works as it should. 

## Tasks

- [] Provide placebo vs duloxetine stratified by dose

### Placebo vs duloxetine

We have a function to identify the studies that contain both the comparators. Let's check it gives us the number of studies we expect.

```{r}
# Count number of studies that have duloxetine
dulox_s <- 
  mod_dat %>%
  filter(
    outcome == "pain_sub",
    intervention == "duloxetine") %>% 
  nrow()

```

```{r}

pw_studies <- 
mod_dat %>% 
  filter(outcome == "pain_sub") %>% 
  find_pw_studies("placebo", "duloxetine", .)

# There should be less than or equal to studies
length(pw_studies) <= dulox_s

```

Now that we have the studies that have both, we can capture the observations.

```{r}
pw_dat <- 
mod_dat %>% 
  filter(
    outcome == "pain_sub",
    intervention %in% c("duloxetine", "placebo"),
    study %in% pw_studies
  )


```

Check we have the right number of studies.

```{r}
pw_dat %>% 
  summarise(studies = n_distinct(study)) %>% 
  pull(studies)

pw_studies %>% length()

```

Now we need to put the data into wide format. First check there is not more than one placebo per study.

```{r}
pw_dat %>% 
  group_by(study) %>% 
  count(intervention) %>% 
  filter(intervention == "placebo") %>% 
  filter(n > 1)

```

Since we have one placebo per study, we can bind the placebo data to the data as the control. Should label as control. Need to capture various things, and this is the tricky part. 

```{r}
pw_wide <-
pw_dat %>% 
  filter(intervention == "placebo") %>% 
  rename_with(~ glue("{.x}_control"), everything()) %>% 
  rename(study = study_control) %>% 
  full_join(pw_dat %>% filter(intervention == "duloxetine"))



```

Check how many studies and arms are expected.

```{r}
pw_dat %>% 
  group_by(study) %>% 
  count(intervention) %>% 
  filter(intervention != "placebo") %>% 
  pull(n) %>% sum()

# Compare with number of rows in wide

pw_wide %>% nrow()

```



```{r}
rma <- 
get_pw_dat(
    dat = mod_dat,
    outcome = "pain_sub",
             type = "ad",
             timepoint = "post_int",
             g1 = "placebo",
             g2 = "duloxetine")  %>% 
  hpp_rma()

rma

```

Now we need a forest plot that can be stratified on class, dose, condition.

```{r}
# write equations

pw_forest_plot()

```

### Getting NMA data

Key thing for these is that we need to exclude single-arm studies.

For example:

```{r }
nma_dat <- 
    mod_dat %>%
    filter(outcome == "pain_int",
           timepoint == "post_int",
           condition == "fibromyalgia",
           dose == "standard") %>% 
    group_by(study) %>%
    mutate(
      study_obs_count = length(study)
    ) %>%
    select(study_obs_count, everything()) %>%
    arrange(study_obs_count, study) %>% 
  ungroup()

nma_dat %>%
    filter(study_obs_count > 1)  %>%
    ungroup() %>% 
  nrow()

  get_nma_dat(nma_dat) %>% 
    nrow()

nma_dat %>% 
  count(outcome)
  
```

```{r error=TRUE}
set_agd_arm(nma_dat[1:3,], study = study, trt = intervention, r = r, n = n)


```

But if we filter out the single-row studies, we get the viable observations for the model, or an empty tibble for no viable observations.


```{r}
nma_dat[1:3,] %>% 
  viable_observations()

nma_dat %>% viable_observations()
```

```{r}
nma_int_dat <-  
  get_nma_dat(mod_dat, outcome == "pain_int",
              dose == "low"
              ) 

nma_int_dat %>% 
  nrow()

nma_int_dat %>% 
  viable_observations() %>% 
  nrow()

```


```{r}
# return a list object with model as one element and meta data as the rest
```

