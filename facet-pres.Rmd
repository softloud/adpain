---
title: "Antidepressants for pain management in adults with chronic pain"
subtitle: "A look at meta-analytic results for pain"
output:
  ioslides_presentation:
    fig_width: 10
    fig_height: 6
    widescreen: true
    transition: faster
# output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE,warning=FALSE)
```

```{r pkgs, message=FALSE,warning=FALSE}
library(tidyverse)
library(gt)
library(here)
library(knitr)
library(patchwork)
library(broom)
library(targets)
library(multinma)

options(mc.cores = parallel::detectCores() - 1)


conflicted::conflict_prefer("filter", "dplyr")


```


```{r targets, message=FALSE,warning=FALSE,include=FALSE}
list.files("R", full.names = TRUE) %>%
  map(source)


msg_mine("Strap in, loading targets.")

tar_load(w_outcome_key)
tar_load(pw_results)
tar_load(m_key_pres)
tar_load(subgroup_type)
tar_load(subgroup_con)
tar_load(subgroup_class)
tar_load(subgroup_dose)
tar_load(m_timepoint_label_key)
tar_load(m_type_label_key)
tar_load(m_type_dat)
tar_load(m_con_dat)
tar_load(m_class_dat)
tar_load(m_dose_dat)

source("plot-fns.R")



```

```{r}

subgroups_fn <- function(subgroup) {
  subgroup %>% 
  left_join(w_outcome_key %>% 
              filter(!str_detect(outcome, "mood_"))) %>% 
  left_join(m_timepoint_label_key) %>% 
  left_join(m_type_label_key)
  
}

subgroup_type <-
  subgroup_type %>% 
  subgroups_fn()

subgroup_class <- 
  subgroup_class %>% 
  subgroups_fn()

subgroup_con <- subgroup_con %>% subgroups_fn()

subgroup_dose <- subgroup_dose %>% subgroups_fn()


```

## Overview

<div class="columns-2">
  
  - Measures of pain
- Outcome results: NMA and pairwise antidepressant comparisons (post-intervention or change-score)
- Duloxetine

<br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  
```{r pain-var}
w_outcome_key %>% 
  filter(!is.na(direction_of_improvement)) %>% 
  select(Outcome = outcome_label) %>% 
  mutate(across(everything(), str_to_sentence)) %>% 
  distinct() %>% 
  gt() %>% 
  tab_style(
    style = cell_text(color = "darkgrey"),
    locations = cells_body(
      columns = c(Outcome),
      rows = !str_detect(Outcome, "ubstantial|dverse|ood")
    )
  ) %>% 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = c(Outcome),
      rows = str_detect(Outcome, "ubstantial|dverse|ood")
    )
  ) %>% 
  tab_header("Outcome results included in this presentation") %>% 
  tab_options(
    table.font.size = 15
  ) %>% 
  tab_source_note("We have collected and analysed results for the outcomes in grey, but in the interests of time, today we will focus on three outcomes.")

```

</div>
  
# Measures of pain
  
## Measures of pain | Do the three outcomes agree?
  
```{r }
w_outcome_key %>%
  filter(str_detect(outcome, "pain")) %>% 
  select(Outcome = outcome_label, Description = description) %>% 
  mutate(across(everything(), str_to_sentence)) %>% 
  gt() %>% 
  tab_header("Measures of pain")

```

<!-- ## Measures of pain | Comparison of pairwise results  -->

<!-- ```{r pw-pain-comp} -->
<!-- tar_read(tab_pain_pw_comp) %>% -->
<!--   filter( -->
<!--     class == "all classes" -->
<!--   ) %>% -->
<!--   select(-contains("model"), -starts_with("dir"), -contains("label")) %>%  -->
<!--   pivot_wider( -->
<!--     names_from = outcome, -->
<!--     values_from = estimate -->
<!--   ) %>%  -->
<!--   filter(!is.na(pain_sub), !is.na(pain_int)) %>%  -->
<!--   select(-type, -timepoint) %>%  -->
<!--   arrange(condition, dose) %>%  -->
<!--   mutate(comp = str_replace(comp, "_", " vs ")) %>%  -->
<!--   gt(groupname_col = "comp") %>%  -->
<!--   tab_header("Pairwise results, pain reduction for duloxetine and milnacipran") %>%  -->
<!--   tab_source_note("Antidepressants at post-intervention compared with placebo. Results shown for subgroups where there was sufficient data to meta-analyse all outcomes.") -->


<!-- ``` -->

## What do we have?

<div class="columns-2">

```{r}
subgroup_dat <- 
subgroup_type %>%
  arrange(outcome, type, timepoint, desc(participants_int), desc(n_studies)) %>%
  filter(str_detect(outcome, "pain")) %>% 
    select(outcome_label, type_label, timepoint_label, participants_int, n_studies)


```

```{r}
subgroup_dat %>%
  filter(!str_detect(outcome_label, "nsity")) %>% 
  gt(
    groupname_col = "outcome_label"
  ) %>% 
  tab_header("Dichotomous") %>% 
  tab_options(table.font.size = 16,
              row_group.background.color = hpp_pal(2)
              ) %>% 
  cols_label(
    type_label = "Comparison",
    timepoint_label = "Category",
    participants_int = "Intervention participants",
    n_studies = "Studies"
  )

```

  <br>
  <br>
  <br>


```{r}
subgroup_dat  %>%
  filter(str_detect(outcome_label, "nsity")) %>% 
  gt(
    groupname_col = "outcome_label"
  ) %>% 
  tab_header("Continuous") %>% 
  tab_options(table.font.size = 16,
              row_group.background.color = hpp_pal(2)
              )  %>% 
  cols_label(
    type_label = "Comparison",
    timepoint_label = "Category",
    participants_int = "Intervention participants",
    n_studies = "Studies"
  )

```

</div>

# Substantial pain

```{r eval=FALSE}
subgroup_type %>% 
  filter(outcome == "pain_sub",
         # timepoint == "post_int",
         type == "ad"
         )

```


```{r }
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_sub",
    timepoint == "post_int",
    type == "ad"
  )

```


```{r eval=FALSE}
nma_pain <- 
  pres_nma(this_key_row)

write_pres_nma(nma_pain, this_key_row)

```

```{r}
nma_pain_sub <- read_rds("data/pres/subgroup_type_pain_sub_ad_post_int_.rds")

```

```{r}
nma_pain_sub_plot <- make_forest(nma_pain_sub, this_key_row) 

```

***

```{r}
nma_pain_sub_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") + 
  coord_cartesian(xlim = c(-1,7.5))

```


***

```{r}
make_forest(nma_pain_sub, this_key_row, this_class = "snri") +
  facet_grid(class ~ ., scales = "free", space = "free") 

```

***

```{r}
make_forest(nma_pain_sub, this_key_row, this_class = "tca") 

```


## Do NMA results for SNRI differ from pairwise comparisons?

```{r }
this_pw <- 
pw_results %>% 
  filter(subgroup == "subgroup_class",
         outcome == "pain_sub",
         class == "snri"
         ) %>% 
  arrange(desc(n_studies)) 

  
this_pw %>%   
  select(int_1, int_2, n_studies) %>% 
  gt() %>% 
  cols_label(
    int_1 = "Control",
    int_2 = "Treatment",
    n_studies = "Studies"
  ) %>% 
  tab_header("Possible meta-analtyic comparisons for SNRI")
  


```

***

```{r}
this_pw[1,]$pw_forest_file %>% read_rds() +
  coord_cartesian(xlim = c(0, 6))

```

*** 
```{r}
this_pw[2,]$pw_forest_file %>% read_rds() 

```

***

```{r}
this_pw[3,]$pw_forest_file %>% read_rds()

```


***

```{r}
this_pw[4,]$pw_forest_file %>% read_rds()

```


##  Substantial pain | Do the results differ for fibromyalgia?

```{r eval=FALSE}
subgroup_con %>% 
  filter(outcome == "pain_sub",
         ) %>% 
  select(outcome, timepoint, condition, participants_int, n_studies, type) %>% 
  arrange(desc(participants_int), desc(n_studies))    

```


```{r }
this_pw <- 
pw_results %>% 
  filter(
    outcome == "pain_sub",
    subgroup == "subgroup_con"
  ) %>% 
  arrange(desc(participants), desc(n_studies))

this_tab <- 
this_pw %>% 
  select(int_1, int_2, condition, participants, n_studies) %>% 
  gt() %>% 
  cols_label(
    int_1 = "Control",
    int_2 = "Treatment",
    n_studies = "Studies",
    condition = "Condition"
  ) %>% 
  tab_header("Duloxetine and milnacipran pairwise for specific conditions")


```


***

```{r }
this_key_row <- 
subgroup_con %>% 
  filter(
    outcome == "pain_sub",
    timepoint == "post_int",
    type == "ad",
    condition == "fibromyalgia"
  )

```


```{r eval=FALSE}
nma_pain_fibro <- 
  pres_nma(this_key_row)

write_pres_nma(nma_pain_fibro, this_key_row)

```

```{r}
nma_pain_fibro <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_con_pain_sub_ad_post_int_fibromyalgia_.rds")

```

```{r}
nma_pain_fibro_plot <- make_forest(nma_pain_fibro, this_key_row) 

```


```{r}
nma_pain_fibro_plot + 
  facet_grid(class ~ ., scales = "free", space = "free")

```

***
```{r}
this_pw %>% 
  filter(condition == "fibromyalgia") %>% 
  slice(1) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```

***
```{r}
this_pw %>% 
  filter(condition == "fibromyalgia") %>% 
  slice(2) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```

***
```{r}
this_pw %>% 
  filter(condition == "fibromyalgia") %>% 
  slice(3) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```

##  Substantial pain | Do the results differ for musculoskeletal?


***


```{r }
this_key_row <- 
subgroup_con %>% 
  filter(
    outcome == "pain_sub",
    timepoint == "post_int",
    type == "ad",
    condition == "musculoskeletal"
  )

```


```{r eval=FALSE}
nma_pain_muscu <- 
  pres_nma(this_key_row)

write_pres_nma(nma_pain_muscu, this_key_row)

```

```{r}
nma_pain_muscu <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_con_pain_sub_ad_post_int_musculoskeletal_.rds")

```

```{r}
nma_pain_muscu_plot <- make_forest(nma_pain_muscu, this_key_row) 

```


```{r}
nma_pain_muscu_plot + 
  facet_grid(class ~ ., scales = "free", space = "free")

```




***
```{r}
this_pw %>% 
  filter(str_detect(condition, "musc")) %>% 
  pull(pw_forest_file) %>% 
  read_rds() +
  coord_cartesian(xlim = c(0, 10))
  
```


## Substantial pain | Do the results differ for neuropathic?

***

```{r }
this_key_row <- 
subgroup_con %>% 
  filter(
    outcome == "pain_sub",
    timepoint == "post_int",
    type == "ad",
    condition == "neuropathic"
  )

```


```{r eval=FALSE}
nma_pain_neuro <- 
  pres_nma(this_key_row)

write_pres_nma(nma_pain_neuro, this_key_row)

```

```{r}
nma_pain_neuro <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_con_pain_sub_ad_post_int_neuropathic_.rds")

```

```{r}
nma_pain_neuro_plot <- make_forest(nma_pain_neuro, this_key_row) 

```


```{r}
nma_pain_neuro_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-2, 4))

```

***
```{r}
this_pw %>% 
  filter(str_detect(condition, "neuro")) %>% 
  slice(1) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```



## Is there a difference in results for dose? | Substantial pain


```{r}
this_pw <- 
pw_results %>% 
  filter(outcome == "pain_sub",
         subgroup == "subgroup_dose"
         )

this_pw %>% 
  select(timepoint_label, comp, dose, n_studies, participants, int_2) %>% 
  arrange(comp, dose) %>%
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Pairwise comparisons of substantial pain by dose") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )
  
```

***

```{r}
this_pw %>% 
  filter(str_detect(int_2, "dulox"), dose == "high") %>% 
  pull(pw_forest_file) %>% 
  read_rds() +
  coord_cartesian(xlim = c(0,5))

```

***

```{r}
this_pw %>% 
  filter(str_detect(int_2, "dulox"), dose == "standard") %>% 
  pull(pw_forest_file) %>% 
  read_rds() +
  coord_cartesian(xlim = c(0,5))

```

***

```{r}
this_pw %>% 
  filter(str_detect(int_2, "dulox"), dose == "low") %>% 
  pull(pw_forest_file) %>% 
  read_rds() +
  coord_cartesian(xlim = c(0,5))

```

## Does desvenlafaxine show the same attributes?

Effective across doses? Results agree across doses?

```{r}
this_pw %>%
  filter(str_detect(int_2, "desv")) %>% 
  select(timepoint_label, comp, dose, n_studies, participants, int_2) %>% 
  arrange(comp, dose) %>%
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Pairwise comparisons of substantial pain by dose") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )
  
```

***


```{r}
this_pw %>% 
  filter(str_detect(int_2, "desv"), dose == "high") %>% 
  pull(pw_forest_file) %>% 
  read_rds()

```

***

```{r}
this_pw %>% 
  filter(str_detect(int_2, "desv"), dose == "standard") %>% 
  pull(pw_forest_file) %>% 
  read_rds() 

```

## Do results agree for milnacipran?

```{r}
this_pw %>%
  filter(str_detect(int_2, "miln")) %>% 
  select(timepoint_label, comp, dose, n_studies, participants, int_2) %>% 
  arrange(comp, dose) %>%
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Pairwise comparisons of substantial pain by dose") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )

```

***

```{r}
this_pw %>% 
  filter(str_detect(int_2, "miln"), dose == "standard") %>% 
  pull(pw_forest_file) %>% 
  read_rds()

```

***

```{r}
this_pw %>% 
  filter(str_detect(int_2, "miln"), dose != "standard") %>% 
  pull(pw_forest_file) %>% 
  read_rds() 

```

***

#### A final look at overall results for substantial pain

***

```{r}
nma_pain_sub_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") + 
  coord_cartesian(xlim = c(-1,7.5))

```




# Pain intensity | continuous measure


***


```{r }
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "change_score",
    type == "ad"
  )

```


```{r eval=FALSE}
nma_pain_int_cs <- 
  pres_nma(this_key_row)

write_pres_nma(nma_pain_int_cs, this_key_row)

```

```{r}
nma_pain_int_cs <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_type_pain_int_ad_change_score_.rds")

```

```{r}
nma_pain_int_cs_plot <- make_forest(nma_pain_int_cs, this_key_row) 

```


```{r}
nma_pain_int_cs_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-4, 1))

```

***

```{r }
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "post_int",
    type == "ad"
  )

```


```{r eval=FALSE}
nma_pain_int <- 
  pres_nma(this_key_row)

write_pres_nma(nma_pain_int, this_key_row)

```

```{r}
nma_pain_int <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_type_pain_int_ad_post_int_.rds")

```

```{r}
nma_pain_int_plot <- make_forest(nma_pain_int, this_key_row) 

```


```{r}
nma_pain_int_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-4, 1))

```

## Pain intensity & SNRI

***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "post_int",
    type == "ad"
  )

make_forest(nma_pain_int, this_key_row, this_class = "snri")

```

***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "change_score",
    type == "ad"
  )

make_forest(nma_pain_int_cs, this_key_row, this_class = "snri")

```

## Direct evidence for SNRI in pain intensity

```{r}
this_pw <-

pw_results %>% 
  filter(subgroup == "subgroup_class",
         outcome == "pain_int",
         class == "snri",
         type == "ad"
         ) %>% 
  arrange(int_2, desc(participants), desc(n_studies)) 

this_pw %>% 
  select(timepoint, comp, n_studies, participants, int_2) %>% 
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Pairwise comparisons of substantial pain by dose") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )

```

***

```{r}
this_pw %>% 
  filter(str_detect(comp, "dulox"), timepoint == "change_score") %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```


***

```{r}
this_pw %>% 
  filter(str_detect(comp, "dulox"), timepoint == "post_int") %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```


***

```{r}
this_pw %>% 
  filter(str_detect(comp, "miln"), timepoint == "change_score") %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```


***

```{r}
this_pw %>% 
  filter(str_detect(comp, "miln"), timepoint == "post_int") %>% 
  pull(pw_forest_file) %>% 
  read_rds()
  
```

## SSRI & pain intensity

***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "change_score",
    type == "ad"
  )

make_forest(nma_pain_int_cs, this_key_row, this_class = "ssri")

```

***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "post_int",
    type == "ad"
  )

make_forest(nma_pain_int, this_key_row, this_class = "ssri")

```

## No direct evidence for SSRI in pain intensity

***

## Pain intensity and TCA

***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "change_score",
    type == "ad"
  )

make_forest(nma_pain_int_cs, this_key_row, this_class = "tca")

```

***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "pain_int",
    timepoint == "post_int",
    type == "ad"
  )

make_forest(nma_pain_int, this_key_row, this_class = "tca")

```

## Pain intensity | Only direct evidence for amitriptyline

```{r}
this_pw <-
pw_results %>% 
  filter(subgroup == "subgroup_class",
         outcome == "pain_int",
         class == "tca",
         type == "ad"
         ) %>% 
  arrange(int_2, desc(participants), desc(n_studies)) 

this_pw %>% 
  select(timepoint, comp, n_studies, participants, int_2) %>% 
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Pairwise comparisons of substantial pain by dose") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )

```

***

```{r}
this_pw$pw_forest_file %>% read_rds()
```


# Mood


***


```{r }
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "mood",
    timepoint == "change_score",
    type == "ad"
  )

```


```{r eval=FALSE}
nma_mood_cs <- 
  pres_nma(this_key_row)

write_pres_nma(nma_mood_cs, this_key_row)

```

```{r}
nma_mood_cs <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_type_mood_ad_change_score_.rds")

```

```{r}
nma_mood_cs_plot <- make_forest(nma_mood_cs, this_key_row) 

```


```{r}
nma_mood_cs_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-6, 4))

```

***


```{r }
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "mood",
    timepoint == "post_int",
    type == "ad"
  )

```


```{r eval=FALSE}
nma_mood_pi <- 
  pres_nma(this_key_row)

write_pres_nma(nma_mood_pi, this_key_row)

```

```{r}
nma_mood_pi <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_type_mood_ad_post_int_.rds")

```

```{r}
nma_mood_pi_plot <- make_forest(nma_mood_pi, this_key_row) 

```


```{r}
nma_mood_pi_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-4, 1))

```

## SNRI and mood

```{r}
this_pw <-
pw_results %>% 
  filter(
    outcome == "mood",
    subgroup == "subgroup_class",
    class == "snri"
  ) %>% 
  group_by(tar_group) %>% 
  slice(1)  %>%
  arrange(comp) %>% 
  ungroup()

this_pw %>% 
  select(timepoint, comp, n_studies, participants, int_2, class) %>% 
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Pairwise comparisons of substantial pain by dose") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )


```

### First we'll look at duloxetine and then the other results

*** 

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "mood",
    timepoint == "change_score",
    type == "ad"
  )


make_forest(nma_mood_cs, this_key_row, this_class = "snri")

```


***

```{r}
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "mood",
    timepoint == "post_int",
    type == "ad"
  )

make_forest(nma_mood_pi, this_key_row, this_class = "snri")

```

*** 



```{r}
this_pw %>% 
  filter(
    str_detect(comp, "dulox"),
    timepoint == "change_score"
  ) %>% 
  pull(pw_forest_file) %>% read_rds()

```

***

```{r}
this_pw %>% 
  filter(
    str_detect(comp, "dulox"),
    timepoint == "post_int"
  ) %>% 
  pull(pw_forest_file) %>% read_rds()

```

***

```{r}
this_pw %>% 
  filter(
    str_detect(comp, "miln")
  ) %>% 
  pull(pw_forest_file) %>% read_rds()

```

# Adverse events

```{r eval=FALSE}
subgroup_type %>% 
  filter(outcome == "adverse") %>% 
  

```


***


```{r }
this_key_row <- 
subgroup_type %>% 
  filter(
    outcome == "adverse",
    timepoint == "post_int",
    type == "ad"
  )

```


```{r eval=FALSE}
nma_adverse <- 
  pres_nma(this_key_row)

write_pres_nma(nma_adverse, this_key_row)

```

```{r}
nma_adverse <- read_rds("/home/cantabile/Documents/gh-repos/adpain/data/pres/subgroup_type_adverse_ad_post_int_.rds")

```

```{r}
nma_adverse_plot <- make_forest(nma_adverse, this_key_row) 

```


```{r}
nma_adverse_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-2, 4))

```

## Adverse events and SNRI

### Only post-intervention results

### Pair-wise comparisons

```{r}
this_pw <- 
pw_results %>% 
  filter(
    subgroup == "subgroup_class",
    outcome == "adverse",
    class == "snri"
  ) %>% 
  arrange(desc(participants), desc(n_studies)) 

this_pw %>% 
  select(comp, n_studies, participants) %>% 
  rename_with(str_to_sentence, everything()) %>% 
  gt() %>% 
  tab_header("Pairwise comparisons of adverse pain for SNRI") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )


```


***

```{r}
make_forest(nma_adverse, this_key_row, this_class = "snri") 

```

***

```{r}
this_pw$pw_forest_file[1] %>% read_rds()

```

*** 

```{r}
this_pw$pw_forest_file[2] %>% read_rds() +
  coord_cartesian(xlim = c(-0.5, 5))

```

*** 

```{r}
this_pw$pw_forest_file[3] %>% read_rds()

```

*** 

```{r}
this_pw$pw_forest_file[4] %>% read_rds()

```

*** 

```{r}
this_pw$pw_forest_file[5] %>% read_rds()

```

## Adverse events & TCA

***

```{r}
make_forest(nma_adverse, this_key_row, this_class = "tca") +
  coord_cartesian(xlim = c(-0.5, 15))

```

## Direct evidence for TCA with adverse events

```{r}
this_pw <- 
pw_results %>% 
  filter(
    subgroup == "subgroup_class",
    outcome == "adverse",
    class == "tca"
  ) %>% 
  arrange(desc(participants), desc(n_studies)) 

this_pw %>% 
  select(comp, n_studies, participants) %>% 
  rename_with(str_to_sentence, everything()) %>% 
  gt() %>% 
  tab_header("Pairwise comparisons of adverse pain for SNRI") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )

```

***

```{r}
this_pw$pw_forest_file[1] %>% read_rds() +
  coord_cartesian(xlim = c(-0.5, 20))

```


***

```{r}
this_pw$pw_forest_file[2] %>% read_rds()

```

## No pairwise analyses available for SSRI

***

```{r}
make_forest(nma_adverse, this_key_row, this_class = "ssri") +
  coord_cartesian(xlim = c(-0.5, 15))

```

## No direct evidence for adverse events by condition

## Adverse events and dose

```{r}
this_pw <- 
pw_results %>% 
  filter(
    subgroup == "subgroup_dose",
    outcome == "adverse"
  ) %>% 
  arrange(desc(participants), desc(n_studies)) 

this_pw %>% 
  select(comp, n_studies, participants, dose, int_2) %>% 
  rename_with(str_to_sentence, everything()) %>% 
  gt(groupname_col = "Int_2") %>% 
  tab_header("Direct evidence for conditions") %>% 
  cols_label(
    N_studies = "Studies",
    Comp = "Comparison"
  ) %>% 
  tab_options(row_group.background.color = hpp_pal(1)
    
  )


```

## Adverse events for duloxetine by dose

***

```{r}
this_pw %>% 
  filter(dose == "high", str_detect(comp, "dulox")) %>% 
  pull(pw_forest_file) %>% 
  read_rds()

```

***

```{r}
this_pw %>% 
  filter(dose == "standard", str_detect(comp, "dulox")) %>% 
  pull(pw_forest_file) %>% 
  read_rds()

```

## Adverse events and conditions

```{r}
this_pw <- 
pw_results %>% 
  filter(
    outcome == "adverse",
    subgroup == "subgroup_con"
  ) %>% 
  arrange(desc(participants), desc(n_studies))

this_pw %>% 
  select(condition, comp, n_studies, participants) %>% 
  gt(
    groupname_col = "condition"
  ) %>% 
  tab_header("Direct evidence by condition") %>% 
  tab_options(row_group.background.color = hpp_pal(1)
  ) %>% 
  cols_label(
    comp = "Comparison",
    n_studies = "Studies",
    participants = "Participants"
  )


```

## Adverse events and fibromyalgia

```{r}
this_pw %>% 
  filter(str_detect(condition, "fibro")) %>% 
    select(condition, comp, n_studies, participants) %>% 
  gt(
    groupname_col = "condition"
  ) %>% 
  tab_header("Direct evidence by condition") %>% 
  tab_options(row_group.background.color = hpp_pal(1)
  ) %>% 
  cols_label(
    comp = "Comparison",
    n_studies = "Studies",
    participants = "Participants"
  )



```


***

```{r}
this_pw %>% 
  filter(str_detect(condition, "fibro")) %>% 
  slice(1) %>% 
  pull(pw_forest_file) %>% 
  read_rds() +
  coord_cartesian(xlim = c(-1, 7.5))

```

***

```{r}
this_pw %>% 
  filter(str_detect(condition, "fibro")) %>% 
  slice(2) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
```

***

```{r}
this_pw %>% 
  filter(str_detect(condition, "fibro")) %>% 
  slice(3) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
```

***
```{r}
this_pw %>% 
  filter(str_detect(condition, "fibro")) %>% 
  slice(4) %>% 
  pull(pw_forest_file) %>% 
  read_rds() +
  coord_cartesian(xlim = c(-1, 5))
  
```

## Adverse events and musculoskeletal

```{r}
this_pw %>% 
  filter(str_detect(condition, "muscu")) %>% 
    select(condition, comp, n_studies, participants) %>% 
  gt(
    groupname_col = "condition"
  ) %>% 
  tab_header("Direct evidence by condition") %>% 
  tab_options(row_group.background.color = hpp_pal(1)
  ) %>% 
  cols_label(
    comp = "Comparison",
    n_studies = "Studies",
    participants = "Participants"
  )



```

***

```{r}
this_pw %>% 
  filter(str_detect(condition, "muscu")) %>% 
  slice(1) %>% 
  pull(pw_forest_file) %>% 
  read_rds()
```

## Adverse events in patients with neuropathic conditions

```{r}
this_pw %>% 
  filter(str_detect(condition, "muscu")) %>% 
    select(condition, comp, n_studies, participants) %>% 
  gt(
    groupname_col = "condition"
  ) %>% 
  tab_header("Direct evidence by condition") %>% 
  tab_options(row_group.background.color = hpp_pal(1)
  ) %>% 
  cols_label(
    comp = "Comparison",
    n_studies = "Studies",
    participants = "Participants"
  )

```

***

```{r}
this_pw %>% 
  filter(str_detect(condition, "muscu")) %>% 
  pull(pw_forest_file) %>% 
  read_rds()

```


## A final look at overall results

```{r}
nma_adverse_plot + 
  facet_grid(class ~ ., scales = "free", space = "free") +
  coord_cartesian(xlim = c(-2, 4))

```

